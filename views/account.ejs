<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Virtual Casino - Account</title>
</head>
<body>
  <%- include('partials/nav'); %>

  <h1>Welcome, <%= user.username %></h1>

  <section>
    <h2>Account Stats</h2>
    <ul>
      <li>Wallet: $<%= user.wallet %></li>
      <li>Total Wins: <%= user.total_wins %></li>
      <li>Total Profit: $<%= user.total_profit %></li>
      <li>Total Money Invested: $<%= user.total_invested %></li>
    </ul>
  </section>

  <section>
    <h2>Choose 3 Players</h2>
    <form action="/choosePlayers" method="POST">
      <select id="cpuSelect" name="cpuIds[]" required multiple size="6">
        <% cpus.forEach(cpu => { %>
          <option value="<%= cpu.id %>"><%= cpu.name %></option>
        <% }); %>
      </select>

      <p id="error" style="color:red;"></p>

      <button type="submit">Play Blackjack</button>
    </form>
  </section>

  <section>
    <h2>Recent History</h2>
    <% if (history.length === 0) { %>
      <p>No games recorded yet.</p>
    <% } else { %>
      <table border="1" cellpadding="4">
        <thead>
          <tr>
            <th>Date</th>
            <th>Dealer</th>
            <th>Result</th>
            <th>Bet</th>
            <th>Profit</th>
          </tr>
        </thead>
        <tbody>
          <% history.forEach(row => { %>
            <tr>
              <td><%= row.played_at %></td>
              <td><%= row.dealer_name || '-' %></td>
              <td><%= row.result %></td>
              <td>$<%= row.bet_amount %></td>
              <td>$<%= row.profit_change %></td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    <% } %>
  </section>

  <script>
    const cpus = document.getElementById("cpuSelect");
    const error = document.getElementById("error");
    const form = document.querySelector("form");

    // Prevent selecting more than 4 CPUs
    cpus.addEventListener("change", () => {
      const selected = [...cpus.options].filter(o => o.selected);

      if (selected.length > 3) {
        selected[selected.length - 1].selected = false;
        error.textContent = "You must select exactly 3 CPUs.";
      } 
      else if (selected.length < 3) {
        error.textContent = "Please select exactly 3 CPUs.";
      } 
      else {
        error.textContent = ""; 
      }
    });

    form.addEventListener("submit", (e) => {
      const selectedCount = [...cpus.options].filter(o => o.selected).length;

      if (selectedCount !== 3) {
        e.preventDefault();
        error.textContent = "You need to select *exactly* 3 CPUs before continuing.";
      }
    });
  </script>
</body>
</html>
